openapi: 3.0.3
info:
  title: Advanced To-Do App - Authentication API
  description: |
    Authentication endpoints for the Advanced To-Do Application UI feature.
    Implements User Story 2 (P2): User Authentication Journey.

    Uses Better Auth for authentication (from constitution).
  version: 1.0.0
  contact:
    name: API Support
servers:
  - url: http://localhost:8000/api
    description: Local development
  - url: https://api.todo-app.example.com/api
    description: Production

tags:
  - name: Authentication
    description: User registration, login, and session management

paths:
  /auth/register:
    post:
      tags:
        - Authentication
      summary: Register new user
      description: |
        Creates a new user account with email, password, and display name.
        Returns user object and JWT authentication token.

        **Acceptance Scenario**: FR-008 from spec.md
      operationId: registerUser
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserRegistration'
            examples:
              validRegistration:
                summary: Valid registration
                value:
                  email: user@example.com
                  password: SecurePass123!
                  displayName: John Doe
      responses:
        '201':
          description: User created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
              examples:
                success:
                  summary: Successful registration
                  value:
                    user:
                      id: 550e8400-e29b-41d4-a716-446655440000
                      email: user@example.com
                      displayName: John Doe
                      createdAt: '2026-01-08T10:30:00Z'
                      updatedAt: '2026-01-08T10:30:00Z'
                    token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
                    expiresAt: '2026-01-15T10:30:00Z'
        '400':
          description: Invalid input
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalidEmail:
                  summary: Invalid email format
                  value:
                    error: Invalid email format
                    message: Please provide a valid email address
                    code: INVALID_EMAIL
                weakPassword:
                  summary: Weak password
                  value:
                    error: Password does not meet requirements
                    message: Password must be at least 8 characters and contain uppercase, lowercase, number, and special character
                    code: WEAK_PASSWORD
                missingField:
                  summary: Missing required field
                  value:
                    error: Validation failed
                    message: displayName is required
                    code: MISSING_FIELD
        '409':
          description: Email already registered
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                emailExists:
                  summary: Email already exists
                  value:
                    error: Email already registered
                    message: An account with this email already exists
                    code: EMAIL_EXISTS
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/login:
    post:
      tags:
        - Authentication
      summary: Sign in existing user
      description: |
        Authenticates user with email and password.
        Returns user object and JWT authentication token.

        **Acceptance Scenario**: FR-009 from spec.md
      operationId: loginUser
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserCredentials'
            examples:
              validLogin:
                summary: Valid credentials
                value:
                  email: user@example.com
                  password: SecurePass123!
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
              examples:
                success:
                  summary: Successful login
                  value:
                    user:
                      id: 550e8400-e29b-41d4-a716-446655440000
                      email: user@example.com
                      displayName: John Doe
                      createdAt: '2026-01-08T10:30:00Z'
                      updatedAt: '2026-01-08T10:30:00Z'
                    token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
                    expiresAt: '2026-01-15T10:30:00Z'
        '401':
          description: Authentication failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalidCredentials:
                  summary: Invalid email or password
                  value:
                    error: Authentication failed
                    message: Invalid email or password
                    code: INVALID_CREDENTIALS
        '429':
          description: Too many failed attempts
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                rateLimited:
                  summary: Rate limit exceeded
                  value:
                    error: Too many attempts
                    message: Too many failed login attempts. Please try again in 1 hour.
                    code: RATE_LIMIT_EXCEEDED
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/logout:
    post:
      tags:
        - Authentication
      summary: Sign out user
      description: |
        Invalidates the current user session.
        Requires valid JWT token in Authorization header.

        **Acceptance Scenario**: FR-023 from spec.md
      operationId: logoutUser
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Logout successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Logged out successfully
        '401':
          description: Unauthorized - invalid or missing token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                noToken:
                  summary: Missing token
                  value:
                    error: Unauthorized
                    message: Authentication token is required
                    code: NO_TOKEN
                invalidToken:
                  summary: Invalid token
                  value:
                    error: Unauthorized
                    message: Invalid or expired token
                    code: INVALID_TOKEN

  /auth/me:
    get:
      tags:
        - Authentication
      summary: Get current user
      description: |
        Returns the currently authenticated user's profile.
        Requires valid JWT token in Authorization header.
      operationId: getCurrentUser
      security:
        - BearerAuth: []
      responses:
        '200':
          description: User profile retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
              examples:
                success:
                  summary: Current user
                  value:
                    id: 550e8400-e29b-41d4-a716-446655440000
                    email: user@example.com
                    displayName: John Doe
                    createdAt: '2026-01-08T10:30:00Z'
                    updatedAt: '2026-01-08T10:30:00Z'
        '401':
          description: Unauthorized - invalid or missing token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/refresh:
    post:
      tags:
        - Authentication
      summary: Refresh authentication token
      description: |
        Generates a new JWT token before the current one expires.
        Extends user session without requiring re-login.
      operationId: refreshToken
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Token refreshed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  token:
                    type: string
                    description: New JWT token
                    example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
                  expiresAt:
                    type: string
                    format: date-time
                    description: New expiration time
                    example: '2026-01-15T10:30:00Z'
        '401':
          description: Unauthorized - token expired or invalid
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token obtained from /auth/login or /auth/register

  schemas:
    User:
      type: object
      required:
        - id
        - email
        - displayName
        - createdAt
        - updatedAt
      properties:
        id:
          type: string
          format: uuid
          description: Unique user identifier
          example: 550e8400-e29b-41d4-a716-446655440000
        email:
          type: string
          format: email
          description: User's email address
          example: user@example.com
        displayName:
          type: string
          minLength: 1
          maxLength: 100
          description: User's display name
          example: John Doe
        createdAt:
          type: string
          format: date-time
          description: Account creation timestamp
          example: '2026-01-08T10:30:00Z'
        updatedAt:
          type: string
          format: date-time
          description: Last update timestamp
          example: '2026-01-08T10:30:00Z'

    UserRegistration:
      type: object
      required:
        - email
        - password
        - displayName
      properties:
        email:
          type: string
          format: email
          description: User's email address (must be unique)
          example: user@example.com
        password:
          type: string
          format: password
          minLength: 8
          description: |
            Password must be at least 8 characters and contain:
            - At least one uppercase letter
            - At least one lowercase letter
            - At least one number
            - At least one special character
          example: SecurePass123!
        displayName:
          type: string
          minLength: 1
          maxLength: 100
          description: User's display name
          example: John Doe

    UserCredentials:
      type: object
      required:
        - email
        - password
      properties:
        email:
          type: string
          format: email
          description: User's email address
          example: user@example.com
        password:
          type: string
          format: password
          description: User's password
          example: SecurePass123!

    AuthResponse:
      type: object
      required:
        - user
        - token
        - expiresAt
      properties:
        user:
          $ref: '#/components/schemas/User'
        token:
          type: string
          description: JWT authentication token
          example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
        expiresAt:
          type: string
          format: date-time
          description: Token expiration time (7 days from issuance)
          example: '2026-01-15T10:30:00Z'

    ErrorResponse:
      type: object
      required:
        - error
        - message
        - code
      properties:
        error:
          type: string
          description: Error title
          example: Validation failed
        message:
          type: string
          description: Human-readable error message
          example: Email is required
        code:
          type: string
          description: Machine-readable error code
          example: MISSING_FIELD
          enum:
            - INVALID_EMAIL
            - WEAK_PASSWORD
            - MISSING_FIELD
            - EMAIL_EXISTS
            - INVALID_CREDENTIALS
            - RATE_LIMIT_EXCEEDED
            - NO_TOKEN
            - INVALID_TOKEN
            - EXPIRED_TOKEN
            - INTERNAL_ERROR
        details:
          type: object
          description: Additional error details (optional)
          additionalProperties: true
