# Data Model: Advanced To-Do Application UI

**Feature**: `003-advanced-todo-ui`
**Date**: 2026-01-08
**Backend**: PostgreSQL (Neon Serverless) + SQLModel (from constitution)

## Overview

This document defines the data entities for the Advanced To-Do Application UI feature. The data model supports three user stories:
- P1: Landing Page Experience (no persistence)
- P2: User Authentication Journey (User, Session entities)
- P3: Dashboard Experience (Task entity)

**Note**: This is a frontend-focused feature. Backend entities follow the constitution's existing structure (FastAPI + SQLModel + PostgreSQL). This document defines the logical data model and TypeScript type definitions for the frontend.

---

## Entity Relationship Diagram

```
┌─────────────┐
│    User     │
└─────────────┘
       │
       │ 1:N
       ├──────────────────────┐
       │                      │
       ▼                      ▼
┌─────────────┐        ┌─────────────┐
│   Session   │        │    Task     │
└─────────────┘        └─────────────┘
```

**Relationships**:
- One User has many Tasks (1:N)
- One User has many Sessions (1:N)
- Tasks belong to exactly one User
- Sessions belong to exactly one User

---

## Entity 1: User

### Description
Represents an authenticated user account. Users can sign up, sign in, and manage their personal to-do tasks.

### Attributes

| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| `id` | UUID | PRIMARY KEY, NOT NULL, UNIQUE | Unique user identifier (generated by database) |
| `email` | String(255) | NOT NULL, UNIQUE | User's email address (used for authentication) |
| `password_hash` | String(255) | NOT NULL | Bcrypt hashed password (never exposed to frontend) |
| `display_name` | String(100) | NOT NULL | User's display name (shown in dashboard) |
| `created_at` | Timestamp | NOT NULL, DEFAULT NOW() | Account creation timestamp |
| `updated_at` | Timestamp | NOT NULL, DEFAULT NOW(), ON UPDATE NOW() | Last update timestamp |

### Validation Rules

- **email**:
  - Must be valid email format (RFC 5322 basic validation)
  - Must be unique across all users
  - Case-insensitive comparison for uniqueness

- **password** (before hashing):
  - Minimum 8 characters
  - Must contain at least one uppercase letter
  - Must contain at least one lowercase letter
  - Must contain at least one number
  - Must contain at least one special character

- **display_name**:
  - Minimum 1 character, maximum 100 characters
  - No leading/trailing whitespace
  - Cannot be empty string after trimming

### TypeScript Type (Frontend)

```typescript
// types/user.ts

export interface User {
  id: string;                  // UUID as string
  email: string;
  displayName: string;         // Camel case for TypeScript convention
  createdAt: string;           // ISO 8601 date string
  updatedAt: string;           // ISO 8601 date string
}

export interface UserRegistration {
  email: string;
  password: string;
  displayName: string;
}

export interface UserCredentials {
  email: string;
  password: string;
}
```

### Backend Model (SQLModel Reference)

```python
# backend/src/models/user.py (from constitution)

from sqlmodel import Field, SQLModel, Relationship
from uuid import UUID, uuid4
from datetime import datetime
from typing import Optional, List

class User(SQLModel, table=True):
    __tablename__ = "users"

    id: UUID = Field(default_factory=uuid4, primary_key=True)
    email: str = Field(unique=True, index=True, max_length=255)
    password_hash: str = Field(max_length=255)
    display_name: str = Field(max_length=100)
    created_at: datetime = Field(default_factory=datetime.utcnow)
    updated_at: datetime = Field(default_factory=datetime.utcnow)

    # Relationships
    tasks: List["Task"] = Relationship(back_populates="user")
    sessions: List["Session"] = Relationship(back_populates="user")
```

### State Transitions

```
[Anonymous] ---(Sign Up)---> [Registered] ---(Sign In)---> [Authenticated]
                                                                  │
                                                                  │
                                                           (Sign Out)
                                                                  │
                                                                  ▼
                                                            [Anonymous]
```

---

## Entity 2: Session

### Description
Represents an active user session. Managed by Better Auth (from constitution). Tracks authenticated user sessions with JWT tokens.

### Attributes

| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| `id` | UUID | PRIMARY KEY, NOT NULL, UNIQUE | Unique session identifier |
| `user_id` | UUID | FOREIGN KEY (users.id), NOT NULL, INDEX | Reference to User |
| `token` | String(512) | NOT NULL, UNIQUE | JWT authentication token |
| `expires_at` | Timestamp | NOT NULL | Session expiration time |
| `created_at` | Timestamp | NOT NULL, DEFAULT NOW() | Session creation time |
| `user_agent` | String(255) | NULLABLE | Browser/device identifier (optional) |
| `ip_address` | String(45) | NULLABLE | User IP address (optional, for security) |

### Validation Rules

- **token**:
  - Must be valid JWT format
  - Must not be expired (expires_at > current time)
  - Must be unique across all sessions

- **expires_at**:
  - Must be in the future when session is created
  - Default: 7 days from creation (per spec assumption)

- **user_id**:
  - Must reference existing user
  - CASCADE delete (deleting user deletes their sessions)

### TypeScript Type (Frontend)

```typescript
// types/session.ts

export interface Session {
  id: string;                  // UUID as string
  userId: string;              // UUID as string
  token: string;               // JWT token
  expiresAt: string;           // ISO 8601 date string
  createdAt: string;           // ISO 8601 date string
}

// Frontend typically only stores token and expiry
export interface AuthToken {
  token: string;
  expiresAt: string;
}
```

### Backend Model (SQLModel Reference)

```python
# backend/src/models/session.py (Better Auth managed)

from sqlmodel import Field, SQLModel, Relationship
from uuid import UUID, uuid4
from datetime import datetime, timedelta
from typing import Optional

class Session(SQLModel, table=True):
    __tablename__ = "sessions"

    id: UUID = Field(default_factory=uuid4, primary_key=True)
    user_id: UUID = Field(foreign_key="users.id", index=True)
    token: str = Field(unique=True, max_length=512)
    expires_at: datetime
    created_at: datetime = Field(default_factory=datetime.utcnow)
    user_agent: Optional[str] = Field(default=None, max_length=255)
    ip_address: Optional[str] = Field(default=None, max_length=45)

    # Relationship
    user: User = Relationship(back_populates="sessions")
```

### State Transitions

```
[No Session] ---(Sign In/Sign Up)---> [Active Session]
                                            │
                                            │
                                     (Expires or Sign Out)
                                            │
                                            ▼
                                      [No Session]
```

---

## Entity 3: Task

### Description
Represents a to-do task belonging to a user. Tasks can be created, read, updated, deleted, and marked as complete/incomplete.

### Attributes

| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| `id` | UUID | PRIMARY KEY, NOT NULL, UNIQUE | Unique task identifier |
| `user_id` | UUID | FOREIGN KEY (users.id), NOT NULL, INDEX | Reference to User (owner) |
| `title` | String(200) | NOT NULL | Task title (required) |
| `description` | Text | NULLABLE | Optional task description |
| `is_completed` | Boolean | NOT NULL, DEFAULT FALSE | Completion status |
| `completed_at` | Timestamp | NULLABLE | When task was marked complete (null if not completed) |
| `created_at` | Timestamp | NOT NULL, DEFAULT NOW() | Task creation timestamp |
| `updated_at` | Timestamp | NOT NULL, DEFAULT NOW(), ON UPDATE NOW() | Last update timestamp |

### Validation Rules

- **title**:
  - Minimum 1 character, maximum 200 characters
  - No leading/trailing whitespace
  - Cannot be empty string after trimming

- **description**:
  - Optional (can be null or empty string)
  - Maximum 5000 characters if provided

- **is_completed**:
  - Boolean (true/false only)
  - Defaults to false on creation

- **completed_at**:
  - Must be null if is_completed is false
  - Must be non-null if is_completed is true
  - Must be >= created_at

- **user_id**:
  - Must reference existing user
  - CASCADE delete (deleting user deletes their tasks)

### TypeScript Type (Frontend)

```typescript
// types/task.ts

export interface Task {
  id: string;                  // UUID as string
  userId: string;              // UUID as string
  title: string;
  description: string | null;  // Nullable
  isCompleted: boolean;
  completedAt: string | null;  // ISO 8601 date string or null
  createdAt: string;           // ISO 8601 date string
  updatedAt: string;           // ISO 8601 date string
}

export interface TaskCreate {
  title: string;
  description?: string | null;
}

export interface TaskUpdate {
  title?: string;
  description?: string | null;
  isCompleted?: boolean;
}

export interface TaskListResponse {
  tasks: Task[];
  total: number;
}
```

### Backend Model (SQLModel Reference)

```python
# backend/src/models/task.py (from constitution)

from sqlmodel import Field, SQLModel, Relationship
from uuid import UUID, uuid4
from datetime import datetime
from typing import Optional

class Task(SQLModel, table=True):
    __tablename__ = "tasks"

    id: UUID = Field(default_factory=uuid4, primary_key=True)
    user_id: UUID = Field(foreign_key="users.id", index=True)
    title: str = Field(max_length=200)
    description: Optional[str] = Field(default=None, max_length=5000)
    is_completed: bool = Field(default=False)
    completed_at: Optional[datetime] = Field(default=None)
    created_at: datetime = Field(default_factory=datetime.utcnow)
    updated_at: datetime = Field(default_factory=datetime.utcnow)

    # Relationship
    user: User = Relationship(back_populates="tasks")
```

### State Transitions

```
[Not Created] ---(Create)---> [Pending] ---(Mark Complete)---> [Completed]
                                   │              │
                                   │              │
                                   │      (Mark Incomplete)
                                   │              │
                                   │              ▼
                                   │         [Pending]
                                   │
                              (Update Title/Desc)
                                   │
                                   ▼
                              [Pending]
                                   │
                                (Delete)
                                   │
                                   ▼
                            [Deleted/Not Exists]
```

---

## Database Indexes

### Performance Optimization

To support efficient queries for dashboard (P3) and authentication (P2):

```sql
-- Users table
CREATE UNIQUE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_created_at ON users(created_at);

-- Sessions table
CREATE INDEX idx_sessions_user_id ON sessions(user_id);
CREATE UNIQUE INDEX idx_sessions_token ON sessions(token);
CREATE INDEX idx_sessions_expires_at ON sessions(expires_at);

-- Tasks table
CREATE INDEX idx_tasks_user_id ON tasks(user_id);
CREATE INDEX idx_tasks_created_at ON tasks(created_at);
CREATE INDEX idx_tasks_is_completed ON tasks(is_completed);

-- Composite index for dashboard query (user's tasks ordered by creation)
CREATE INDEX idx_tasks_user_created ON tasks(user_id, created_at DESC);

-- Composite index for filtering completed tasks
CREATE INDEX idx_tasks_user_completed ON tasks(user_id, is_completed, created_at DESC);
```

### Query Patterns

**Dashboard - Load all tasks for user (most common)**:
```sql
SELECT * FROM tasks
WHERE user_id = $1
ORDER BY created_at DESC
LIMIT 500;
```
Uses: `idx_tasks_user_created`

**Dashboard - Load only pending tasks**:
```sql
SELECT * FROM tasks
WHERE user_id = $1 AND is_completed = FALSE
ORDER BY created_at DESC;
```
Uses: `idx_tasks_user_completed`

**Auth - Validate session token**:
```sql
SELECT * FROM sessions
WHERE token = $1 AND expires_at > NOW();
```
Uses: `idx_sessions_token`, `idx_sessions_expires_at`

---

## Data Flow Diagrams

### User Story 2: Authentication Flow

```
[Frontend: SignUpForm]
        │
        │ POST /api/auth/register
        │ { email, password, displayName }
        ▼
[Backend: POST /api/auth/register]
        │
        ├─ Validate input
        ├─ Hash password (bcrypt)
        ├─ Create User record
        ├─ Create Session record
        └─ Generate JWT token
        │
        ▼
[Response: { user, token, expiresAt }]
        │
        ▼
[Frontend: Store token, redirect to /dashboard]
```

### User Story 3: Task CRUD Flow

**Create Task**:
```
[Frontend: AddTaskForm]
        │
        │ POST /api/tasks
        │ { title, description }
        │ Authorization: Bearer <token>
        ▼
[Backend: POST /api/tasks]
        │
        ├─ Validate JWT token
        ├─ Extract user_id from token
        ├─ Create Task record with user_id
        └─ Return task
        │
        ▼
[Response: { task }]
        │
        ▼
[Frontend: Optimistic update, add to task list]
```

**Read Tasks**:
```
[Frontend: Dashboard loads]
        │
        │ GET /api/tasks
        │ Authorization: Bearer <token>
        ▼
[Backend: GET /api/tasks]
        │
        ├─ Validate JWT token
        ├─ Extract user_id from token
        ├─ Query tasks WHERE user_id = <user_id>
        └─ Return tasks array
        │
        ▼
[Response: { tasks: [...], total: N }]
        │
        ▼
[Frontend: Render TaskList]
```

---

## API Response Examples

### User Response
```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "email": "user@example.com",
  "displayName": "John Doe",
  "createdAt": "2026-01-08T10:30:00Z",
  "updatedAt": "2026-01-08T10:30:00Z"
}
```

### Task Response
```json
{
  "id": "7c9e6679-7425-40de-944b-e07fc1f90ae7",
  "userId": "550e8400-e29b-41d4-a716-446655440000",
  "title": "Buy groceries",
  "description": "Milk, eggs, bread, and coffee",
  "isCompleted": false,
  "completedAt": null,
  "createdAt": "2026-01-08T12:45:00Z",
  "updatedAt": "2026-01-08T12:45:00Z"
}
```

### Task List Response
```json
{
  "tasks": [
    {
      "id": "7c9e6679-7425-40de-944b-e07fc1f90ae7",
      "userId": "550e8400-e29b-41d4-a716-446655440000",
      "title": "Buy groceries",
      "description": "Milk, eggs, bread, and coffee",
      "isCompleted": false,
      "completedAt": null,
      "createdAt": "2026-01-08T12:45:00Z",
      "updatedAt": "2026-01-08T12:45:00Z"
    },
    {
      "id": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
      "userId": "550e8400-e29b-41d4-a716-446655440000",
      "title": "Finish project report",
      "description": null,
      "isCompleted": true,
      "completedAt": "2026-01-08T15:00:00Z",
      "createdAt": "2026-01-07T09:00:00Z",
      "updatedAt": "2026-01-08T15:00:00Z"
    }
  ],
  "total": 2
}
```

---

## Security Considerations

1. **Password Storage**: Always hash passwords with bcrypt (work factor 12+), never store plaintext
2. **JWT Tokens**: Store securely in httpOnly cookies (not localStorage to prevent XSS)
3. **User ID Isolation**: All task queries MUST filter by authenticated user's ID (prevent data leaks)
4. **Session Expiration**: Automatically invalidate expired sessions (cleanup job runs daily)
5. **CSRF Protection**: Use CSRF tokens for state-changing operations
6. **Rate Limiting**: Limit auth attempts (5 failed logins per hour per IP)

---

## Data Retention

- **Users**: Retained indefinitely (or until user requests deletion)
- **Tasks**: Retained indefinitely while user account exists
- **Sessions**: Auto-deleted after expiration (cleanup job runs daily)
- **Completed Tasks**: Retained (not auto-archived unless user deletes)

---

## Migration Notes

**Initial Schema** (Alembic migration for backend):
```sql
-- V001: Create users, sessions, tasks tables
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  email VARCHAR(255) UNIQUE NOT NULL,
  password_hash VARCHAR(255) NOT NULL,
  display_name VARCHAR(100) NOT NULL,
  created_at TIMESTAMP NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE sessions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  token VARCHAR(512) UNIQUE NOT NULL,
  expires_at TIMESTAMP NOT NULL,
  created_at TIMESTAMP NOT NULL DEFAULT NOW(),
  user_agent VARCHAR(255),
  ip_address VARCHAR(45)
);

CREATE TABLE tasks (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  title VARCHAR(200) NOT NULL,
  description TEXT,
  is_completed BOOLEAN NOT NULL DEFAULT FALSE,
  completed_at TIMESTAMP,
  created_at TIMESTAMP NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMP NOT NULL DEFAULT NOW()
);

-- Indexes (see Database Indexes section above)
```

---

## Next Steps

Data model complete. Ready for:
1. API contract generation (`contracts/auth.yaml`, `contracts/tasks.yaml`)
2. Test scenario documentation (`quickstart.md`)
